<div class="h-full flex flex-col gap-4">
  <div>
    <h2 class="text-xl font-semibold text-desert-fg">Advanced Diagnostics</h2>
    <p class="text-sm text-desert-tan">Live node information and tools. This page uses HTMX for SPA navigation and a WebSocket for realtime updates.</p>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <!-- Live diagnostics card -->
    <div class="bg-desert-darkgray rounded shadow-lg p-4 border border-desert-gray">
      <h3 class="font-medium mb-2 text-desert-yellow">Live Node Stats</h3>
      <div id="diag-stats" class="text-sm space-y-1">
        <div><span class="text-desert-tan">Time:</span> <span id="diag-time" class="text-desert-cyan">—</span></div>
        <div><span class="text-desert-tan">Node ID:</span> <span id="diag-nodeid" class="font-mono text-desert-cyan">—</span></div>
        <div><span class="text-desert-tan">Hosts in state:</span> <span id="diag-hosts" class="text-desert-cyan">—</span></div>
        <div><span class="text-desert-tan">WS status:</span> <span id="diag-ws" class="text-desert-yellow">connecting…</span></div>
      </div>
    </div>

    <!-- iFrame tools -->
    <div class="bg-desert-darkgray rounded shadow-lg p-4 border border-desert-gray">
      <h3 class="font-medium mb-2 text-desert-yellow">Tools</h3>
      <div class="text-sm text-desert-tan mb-2">Additional diagnostics content is embedded below:</div>
      <div class="h-72 border border-desert-gray rounded overflow-hidden">
        <iframe src="/diagnostics" title="Diagnostics"></iframe>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const wsIndicator = document.getElementById('diag-ws');
      const tEl = document.getElementById('diag-time');
      const idEl = document.getElementById('diag-nodeid');
      const hostsEl = document.getElementById('diag-hosts');

      function connect() {
        const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
        const url = proto + '://' + location.host + '/ws/diagnostics';
        const ws = new WebSocket(url);
        wsIndicator.textContent = 'connecting…'; wsIndicator.className = 'text-desert-yellow';
        ws.onopen = () => { wsIndicator.textContent = 'connected'; wsIndicator.className = 'text-desert-green'; };
        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg.time) tEl.textContent = msg.time;
            if (msg.node_id) idEl.textContent = msg.node_id;
            if (typeof msg.hosts_count === 'number') hostsEl.textContent = msg.hosts_count;
          } catch(e) {}
        };
        ws.onclose = () => { wsIndicator.textContent = 'disconnected'; wsIndicator.className = 'text-desert-red'; setTimeout(connect, 1500); };
        ws.onerror = () => { try { ws.close(); } catch(e) {} };
      }
      connect();
    })();
  </script>
</div>

<!-- Breadcrumb update after swap -->
<script>
  document.querySelector('.breadcrumbs').innerHTML =
    `<a class="text-desert-yellow hover:text-desert-orange py-2 cursor-pointer" hx-get="/views/home" hx-target="#content-area" hx-push-url="/">Home</a>
     <span class="text-desert-gray">/</span>
     <span class="text-desert-tan py-2">Advanced</span>`;
  htmx.process(document.querySelector('.breadcrumbs'));
  </script>
