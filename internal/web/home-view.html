<h2 class="text-xl font-semibold mb-3 text-desert-fg">Signage Fleet</h2>

<div class="host-list"
     id="host-list-container"
     hx-get="/views/home"
     hx-trigger="refreshHosts from:body"
     hx-swap="innerHTML"
     hx-select=".host-list"
     hx-target=".host-list">

    <div class="mb-4 flex items-center gap-4">
        <button
            id="check-hosts-btn"
            class="bg-desert-cyan hover:bg-desert-yellow text-desert-darkgray px-4 py-2 rounded"
            onclick="checkAllHostsWithSSE()">
            üîÑ Check All Hosts
        </button>
        <span class="text-desert-tan text-sm">
            Auto-refresh in <span id="countdown-container"><span id="countdown" class="font-bold text-desert-cyan">10</span>s</span>
        </span>
    </div>

    <table class="min-w-full bg-desert-darkgray shadow-lg rounded overflow-hidden border border-desert-gray">
        <thead>
            <tr class="bg-desert-gray text-left text-desert-tan text-sm">
                <th class="px-4 py-3">Nickname [Hostname]</th>
                <th class="px-4 py-3">LAN IP</th>
                <th class="px-4 py-3">VPN IP</th>
                <th class="px-4 py-3">NSM Dash</th>
                <th class="px-4 py-3">Anthias Dash</th>
                <th class="px-4 py-3">Notes</th>
                <th class="px-4 py-3">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-desert-gray">
            {{range .Hosts}}
            <tr data-ip="{{.IPAddress}}" data-vpn="{{.VPNIPAddress}}" data-hostname="{{.Hostname}}">
                <td class="px-4 py-2 align-top">
                    <div class="nickname-display text-desert-tan">
                        {{if .Nickname}}{{.Nickname}}{{else}}<span class="text-desert-gray italic">unnamed</span>{{end}}
                        {{if .Hostname}} <span class="text-desert-gray text-xs">({{.Hostname}})</span>{{end}}
                        {{if or (eq .IPAddress $.CurrentHostIP) (and .VPNIPAddress (eq .VPNIPAddress $.CurrentHostIP))}}
                            <span class="text-desert-cyan text-xs">(current)</span>
                        {{end}}
                    </div>
                    <input type="text"
                           class="nickname-edit hidden bg-desert-gray text-desert-fg px-2 py-1 rounded w-full"
                           value="{{.Nickname}}"
                           placeholder="Friendly label">
                </td>
                <td class="px-4 py-2 align-top">
                    <div class="ip-lan-display text-desert-tan font-mono">
                        {{.IPAddress}}
                        <span class="checking-indicator invisible text-orange-400 italic text-xs ml-2">(checking)</span>
                    </div>
                    <input type="text"
                           class="lan-ip-edit hidden bg-desert-gray text-desert-fg px-2 py-1 rounded w-full font-mono"
                           value="{{.IPAddress}}"
                           placeholder="192.168.1.100">
                </td>
                <td class="px-4 py-2 align-top">
                    <div class="vpn-ip-display font-mono {{if .VPNIPAddress}}text-desert-tan{{else}}text-desert-gray italic{{end}}">
                        {{if .VPNIPAddress}}{{.VPNIPAddress}}{{else}}‚Äî{{end}}
                    </div>
                    <input type="text"
                           class="vpn-ip-edit hidden bg-desert-gray text-desert-fg px-2 py-1 rounded w-full font-mono"
                           value="{{.VPNIPAddress}}"
                           placeholder="100.64.x.x">
                </td>
                <td class="px-4 py-2 align-top">
                    <div class="flex flex-col gap-1">
                        <div class="inline-flex items-center gap-2">
                            {{if eq .Status "healthy"}}
                            <span class="w-2 h-2 rounded-full bg-green-500" title="NSM Online (LAN)"></span>
                            <a href="{{if .DashboardURL}}{{.DashboardURL}}{{else}}{{printf "http://%s:8080" .IPAddress}}{{end}}"
                               target="_blank" rel="noopener noreferrer"
                               class="text-green-400 hover:text-green-300 underline">
                                NSM Online (LAN)
                            </a>
                            {{else if eq .Status "stale"}}
                            <span class="w-2 h-2 rounded-full bg-purple-500" title="Stale - Update Required"></span>
                            <button class="text-purple-400 hover:text-purple-300 underline cursor-pointer"
                                    hx-post="/api/hosts/upgrade"
                                    hx-vals='{"target_ip":"{{.IPAddress}}"}'
                                    hx-confirm="Run package upgrade (apt update && apt upgrade -y) on {{.IPAddress}}?"
                                    hx-swap="none">
                                Stale (LAN)
                            </button>
                            {{else if eq .Status "unhealthy"}}
                            <span class="w-2 h-2 rounded-full bg-yellow-500" title="Unhealthy"></span>
                            <button class="text-yellow-400 hover:text-yellow-300 underline cursor-pointer"
                                    hx-post="/api/hosts/upgrade"
                                    hx-vals='{"target_ip":"{{.IPAddress}}"}'
                                    hx-confirm="Run package upgrade (apt update && apt upgrade -y) on {{.IPAddress}}?"
                                    hx-swap="none">
                                Unhealthy (LAN)
                            </button>
                            {{else if eq .Status "connection_refused"}}
                            <span class="w-2 h-2 rounded-full bg-orange-500" title="Connection Refused"></span>
                            <span class="text-orange-400">Connection Refused (LAN)</span>
                            {{else}}
                            <span class="w-2 h-2 rounded-full bg-red-500" title="Unreachable"></span>
                            <span class="text-red-400">Unreachable (LAN)</span>
                            {{end}}
                        </div>
                        {{if .VPNIPAddress}}
                        <div class="inline-flex items-center gap-2">
                            {{if eq .StatusVPN "healthy"}}
                            <span class="w-2 h-2 rounded-full bg-green-500" title="NSM Online (VPN)"></span>
                            <a href="{{if .DashboardURLVPN}}{{.DashboardURLVPN}}{{else}}{{printf "http://%s:8080" .VPNIPAddress}}{{end}}"
                               target="_blank" rel="noopener noreferrer"
                               class="text-green-400 hover:text-green-300 underline">
                                NSM Online (VPN)
                            </a>
                            {{else if eq .StatusVPN "stale"}}
                            <span class="w-2 h-2 rounded-full bg-purple-500" title="Stale - Update Required"></span>
                            <button class="text-purple-400 hover:text-purple-300 underline cursor-pointer"
                                    hx-post="/api/hosts/upgrade"
                                    hx-vals='{"target_ip":"{{.VPNIPAddress}}"}'
                                    hx-confirm="Run package upgrade (apt update && apt upgrade -y) on {{.VPNIPAddress}}?"
                                    hx-swap="none">
                                Stale (VPN)
                            </button>
                            {{else if eq .StatusVPN "unhealthy"}}
                            <span class="w-2 h-2 rounded-full bg-yellow-500" title="Unhealthy"></span>
                            <button class="text-yellow-400 hover:text-yellow-300 underline cursor-pointer"
                                    hx-post="/api/hosts/upgrade"
                                    hx-vals='{"target_ip":"{{.VPNIPAddress}}"}'
                                    hx-confirm="Run package upgrade (apt update && apt upgrade -y) on {{.VPNIPAddress}}?"
                                    hx-swap="none">
                                Unhealthy (VPN)
                            </button>
                            {{else if eq .StatusVPN "connection_refused"}}
                            <span class="w-2 h-2 rounded-full bg-orange-500" title="Connection Refused"></span>
                            <span class="text-orange-400">Connection Refused (VPN)</span>
                            {{else if .StatusVPN}}
                            <span class="w-2 h-2 rounded-full bg-red-500" title="Unreachable"></span>
                            <span class="text-red-400">Unreachable (VPN)</span>
                            {{else}}
                            <span class="text-gray-500">No NSM data (VPN)</span>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                </td>
                <td class="px-4 py-2 align-top">
                    <div class="flex flex-col gap-1">
                        <div>
                            {{if eq .CMSStatus "CMS Online"}}
                            <a href="http://{{.IPAddress}}" target="_blank" rel="noopener noreferrer"
                               class="text-green-400 hover:text-green-300 cursor-pointer underline">
                                CMS Online (LAN){{if gt .AssetCount 0}} ({{.AssetCount}}){{end}}
                            </a>
                            {{else if eq .CMSStatus "CMS Offline"}}
                            <button class="text-red-400 hover:text-red-300 cursor-pointer underline"
                                    hx-post="/api/hosts/reboot"
                                    hx-vals='{"target_ip":"{{.IPAddress}}"}'
                                    hx-confirm="Reboot host {{.IPAddress}}? This will stop Docker and restart the system."
                                    hx-swap="none">
                                CMS Offline (LAN)
                            </button>
                            {{else}}
                            <span class="text-gray-400">CMS Unknown (LAN)</span>
                            {{end}}
                        </div>
                        {{if .VPNIPAddress}}
                        <div>
                            {{if eq .CMSStatusVPN "CMS Online"}}
                            <a href="http://{{.VPNIPAddress}}" target="_blank" rel="noopener noreferrer"
                               class="text-green-400 hover:text-green-300 cursor-pointer underline">
                                CMS Online (VPN){{if gt .AssetCountVPN 0}} ({{.AssetCountVPN}}){{end}}
                            </a>
                            {{else if eq .CMSStatusVPN "CMS Offline"}}
                            <button class="text-red-400 hover:text-red-300 cursor-pointer underline"
                                    hx-post="/api/hosts/reboot"
                                    hx-vals='{"target_ip":"{{.VPNIPAddress}}"}'
                                    hx-confirm="Reboot host {{.VPNIPAddress}}? This will stop Docker and restart the system."
                                    hx-swap="none">
                                CMS Offline (VPN)
                            </button>
                            {{else}}
                            <span class="text-gray-500">CMS Unknown (VPN)</span>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                </td>
                <td class="px-4 py-2 align-top">
                    <div class="notes-display whitespace-pre-wrap {{if .Notes}}text-desert-tan{{else}}text-desert-gray italic{{end}}">
                        {{if .Notes}}{{.Notes}}{{else}}‚Äî{{end}}
                    </div>
                    <textarea class="notes-edit hidden bg-desert-gray text-desert-fg px-2 py-1 rounded w-full" rows="2" placeholder="Optional notes">{{.Notes}}</textarea>
                </td>
                <td class="px-4 py-2 align-top text-right">
                    <div class="flex justify-end items-center gap-3">
                        {{if eq .CMSStatus "CMS Online"}}
                        <button class="info-btn text-blue-400 hover:text-blue-300 text-lg" title="Info" onclick="toggleInfo(this, '{{.IPAddress}}')">‚ÑπÔ∏è</button>
                        {{end}}
                        <button class="edit-btn text-desert-cyan hover:text-desert-yellow text-lg" title="Edit" onclick="enterEditMode(this)">‚úèÔ∏è</button>
                        <button class="save-btn hidden text-green-400 hover:text-green-300 text-lg font-bold" title="Save" onclick="saveEdit(this)">‚úì</button>
                        <button class="cancel-btn hidden text-red-400 hover:text-red-300 text-lg font-bold" title="Cancel" onclick="cancelEdit(this)">‚úó</button>
                        <button
                            class="text-red-400 hover:text-red-300"
                            title="Delete"
                            hx-post="/api/hosts/delete?ip={{.IPAddress}}"
                            hx-confirm="Delete host {{.IPAddress}}?"
                            hx-target="closest tr"
                            hx-swap="outerHTML swap:1s">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>

    <div class="mt-6 p-4 bg-desert-gray rounded">
        <h3 class="text-lg font-semibold mb-3 text-desert-fg">Add New Host</h3>
        <form id="add-host-form" onsubmit="addHost(event)">
            <div class="grid gap-4 md:grid-cols-2">
                <div>
                    <label for="new-nickname" class="block text-sm text-desert-tan mb-1">Nickname</label>
                    <input type="text"
                           id="new-nickname"
                           name="nickname"
                           placeholder="Lobby Display"
                           class="w-full bg-desert-darkgray text-desert-fg px-3 py-2 rounded border border-desert-gray focus:border-desert-cyan">
                </div>
                <div>
                    <label for="new-lan-ip" class="block text-sm text-desert-tan mb-1">LAN IP *</label>
                    <input type="text"
                           id="new-lan-ip"
                           name="ip_address"
                           required
                           placeholder="192.168.1.100"
                           class="w-full bg-desert-darkgray text-desert-fg px-3 py-2 rounded border border-desert-gray focus:border-desert-cyan font-mono">
                </div>
                <div>
                    <label for="new-vpn-ip" class="block text-sm text-desert-tan mb-1">VPN IP (optional)</label>
                    <input type="text"
                           id="new-vpn-ip"
                           name="vpn_ip_address"
                           placeholder="100.64.0.15"
                           class="w-full bg-desert-darkgray text-desert-fg px-3 py-2 rounded border border-desert-gray focus:border-desert-cyan font-mono">
                </div>
                <div class="md:col-span-2">
                    <label for="new-notes" class="block text-sm text-desert-tan mb-1">Notes</label>
                    <textarea id="new-notes"
                              name="notes"
                              rows="2"
                              placeholder="Mounting location, maintenance windows, etc."
                              class="w-full bg-desert-darkgray text-desert-fg px-3 py-2 rounded border border-desert-gray focus:border-desert-cyan"></textarea>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit"
                            class="bg-desert-cyan hover:bg-desert-yellow text-desert-darkgray px-6 py-2 rounded font-semibold">
                        Add Host
                    </button>
                </div>
            </div>
        </form>
    </div>

    {{if gt (len .Hosts) 1}}
    <div class="mt-4">
        <button
            class="bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded font-semibold"
            hx-post="/api/hosts/push"
            hx-swap="none"
            hx-confirm="Push current host list to all other hosts?">
            üì§ Push to Other Hosts
        </button>
        <span class="ml-4 text-sm text-desert-gray">Push the current host list to all network members</span>
    </div>
    {{end}}
</div>

<script>
const HOST_TABLE_COLUMN_COUNT = 7;
const ipv4Pattern = /^(25[0-5]|2[0-4]\d|1?\d?\d)(\.(25[0-5]|2[0-4]\d|1?\d?\d)){3}$/;

function validateIPv4(value) {
    if (!value) {
        return false;
    }
    return ipv4Pattern.test(value);
}

if (typeof window.countdownValue === 'undefined') {
    window.countdownValue = 10;
    window.countdownInterval = null;
    window.isCheckingInProgress = false;
}

window.isAnyRecordInEditMode = function() {
    const editButtons = document.querySelectorAll('.save-btn:not(.hidden)');
    return editButtons.length > 0;
};

window.isUserInFormField = function() {
    const activeElement = document.activeElement;
    if (!activeElement) return false;
    const tagName = activeElement.tagName.toLowerCase();
    return tagName === 'input' || tagName === 'textarea' || tagName === 'select';
};

window.triggerHostsRefresh = function() {
    if (!window.isAnyRecordInEditMode()) {
        htmx.trigger('#host-list-container', 'refreshHosts');
    }
};

window.updateCountdownDisplay = function() {
    const container = document.getElementById('countdown-container');
    if (!container) return;

    const inEditMode = window.isAnyRecordInEditMode();
    const inFormField = window.isUserInFormField();

    if (inEditMode || inFormField) {
        container.innerHTML = '<span class="text-orange-400 italic">editing...</span>';
    } else if (window.isCheckingInProgress) {
        container.innerHTML = '<span class="text-cyan-400 italic">checking...</span>';
    } else {
        container.innerHTML = '<span id="countdown" class="font-bold text-desert-cyan">' + window.countdownValue + '</span>s';
    }
};

window.checkAllHostsWithSSE = function() {
    window.isCheckingInProgress = true;
    window.updateCountdownDisplay();
    window.resetCountdown();

    document.querySelectorAll('.checking-indicator').forEach(el => {
        el.classList.add('invisible');
    });

    fetch('/api/hosts/check-stream', {
        method: 'POST',
        headers: {
            'Accept': 'text/event-stream',
        }
    }).then(response => {
        if (!response.ok) {
            throw new Error('HTTP error');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    window.isCheckingInProgress = false;
                    window.updateCountdownDisplay();
                    setTimeout(() => {
                        window.triggerHostsRefresh();
                    }, 500);
                    return;
                }

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            if (data.status === 'checking') {
                                const row = document.querySelector(`tr[data-ip="${data.ip}"]`);
                                if (row) {
                                    const indicator = row.querySelector('.checking-indicator');
                                    if (indicator) {
                                        indicator.classList.remove('invisible');
                                    }
                                }
                            } else if (data.status === 'complete') {
                                const row = document.querySelector(`tr[data-ip="${data.ip}"]`);
                                if (row) {
                                    const indicator = row.querySelector('.checking-indicator');
                                    if (indicator) {
                                        indicator.classList.add('invisible');
                                    }
                                }
                            } else if (data.status === 'done') {
                                window.isCheckingInProgress = false;
                                window.updateCountdownDisplay();
                            }
                        } catch (e) {
                            // Ignore JSON parse errors
                        }
                    }
                });

                readStream();
            }).catch(() => {
                window.isCheckingInProgress = false;
                window.updateCountdownDisplay();
            });
        }

        readStream();
    }).catch(() => {
        window.isCheckingInProgress = false;
        window.updateCountdownDisplay();
    });
};

window.startCountdown = function() {
    if (window.countdownInterval) {
        clearInterval(window.countdownInterval);
    }

    window.updateCountdownDisplay();

    window.countdownInterval = setInterval(() => {
        const inEditMode = window.isAnyRecordInEditMode();
        const inFormField = window.isUserInFormField();

        if (inEditMode || inFormField || window.isCheckingInProgress) {
            window.updateCountdownDisplay();
            return;
        }

        window.countdownValue--;
        window.updateCountdownDisplay();

        if (window.countdownValue <= 0) {
            window.checkAllHostsWithSSE();
            window.resetCountdown();
        }
    }, 1000);
};

window.resetCountdown = function() {
    window.countdownValue = 10;
    window.updateCountdownDisplay();
};

window.enterEditMode = function(button) {
    const row = button.closest('tr');

    const nicknameDisplay = row.querySelector('.nickname-display');
    const nicknameInput = row.querySelector('.nickname-edit');
    const lanDisplay = row.querySelector('.ip-lan-display');
    const lanInput = row.querySelector('.lan-ip-edit');
    const vpnDisplay = row.querySelector('.vpn-ip-display');
    const vpnInput = row.querySelector('.vpn-ip-edit');
    const notesDisplay = row.querySelector('.notes-display');
    const notesInput = row.querySelector('.notes-edit');

    if (nicknameDisplay && nicknameInput) {
        nicknameDisplay.classList.add('hidden');
        nicknameInput.classList.remove('hidden');
    }

    if (lanDisplay && lanInput) {
        lanDisplay.classList.add('hidden');
        lanInput.classList.remove('hidden');
    }

    if (vpnDisplay && vpnInput) {
        vpnDisplay.classList.add('hidden');
        vpnInput.classList.remove('hidden');
    }

    if (notesDisplay && notesInput) {
        notesDisplay.classList.add('hidden');
        notesInput.classList.remove('hidden');
    }

    [nicknameInput, lanInput, vpnInput, notesInput].forEach(el => {
        if (el) {
            el.dataset.originalValue = el.value;
        }
    });

    row.querySelector('.edit-btn').classList.add('hidden');
    row.querySelector('.save-btn').classList.remove('hidden');
    row.querySelector('.cancel-btn').classList.remove('hidden');

    const enterHandler = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            window.saveEdit(row.querySelector('.save-btn'));
        }
    };

    [nicknameInput, lanInput, vpnInput].forEach(el => el && el.addEventListener('keydown', enterHandler));
    notesInput && notesInput.addEventListener('keydown', enterHandler);

    if (lanInput) {
        lanInput.focus();
    }

    window.resetCountdown();
};

window.cancelEdit = function(button) {
    const row = button.closest('tr');

    const nicknameDisplay = row.querySelector('.nickname-display');
    const nicknameInput = row.querySelector('.nickname-edit');
    const lanDisplay = row.querySelector('.ip-lan-display');
    const lanInput = row.querySelector('.lan-ip-edit');
    const vpnDisplay = row.querySelector('.vpn-ip-display');
    const vpnInput = row.querySelector('.vpn-ip-edit');
    const notesDisplay = row.querySelector('.notes-display');
    const notesInput = row.querySelector('.notes-edit');

    [nicknameInput, lanInput, vpnInput, notesInput].forEach(el => {
        if (el && typeof el.dataset.originalValue !== 'undefined') {
            el.value = el.dataset.originalValue;
        }
    });

    if (nicknameDisplay && nicknameInput) {
        nicknameDisplay.classList.remove('hidden');
        nicknameInput.classList.add('hidden');
    }
    if (lanDisplay && lanInput) {
        lanDisplay.classList.remove('hidden');
        lanInput.classList.add('hidden');
    }
    if (vpnDisplay && vpnInput) {
        vpnDisplay.classList.remove('hidden');
        vpnInput.classList.add('hidden');
    }
    if (notesDisplay && notesInput) {
        notesDisplay.classList.remove('hidden');
        notesInput.classList.add('hidden');
    }

    row.querySelector('.edit-btn').classList.remove('hidden');
    row.querySelector('.save-btn').classList.add('hidden');
    row.querySelector('.cancel-btn').classList.add('hidden');

    window.resetCountdown();
};

window.saveEdit = function(button) {
    const row = button.closest('tr');
    const oldIP = row.dataset.ip;

    const nicknameDisplay = row.querySelector('.nickname-display');
    const nicknameInput = row.querySelector('.nickname-edit');
    const lanDisplay = row.querySelector('.ip-lan-display');
    const lanInput = row.querySelector('.lan-ip-edit');
    const vpnDisplay = row.querySelector('.vpn-ip-display');
    const vpnInput = row.querySelector('.vpn-ip-edit');
    const notesDisplay = row.querySelector('.notes-display');
    const notesInput = row.querySelector('.notes-edit');

    const nickname = nicknameInput ? nicknameInput.value.trim() : '';
    const newIP = lanInput ? lanInput.value.trim() : '';
    const newVPN = vpnInput ? vpnInput.value.trim() : '';
    const notes = notesInput ? notesInput.value.trim() : '';

    if (!validateIPv4(newIP)) {
        alert('Please enter a valid LAN IPv4 address.');
        return;
    }

    if (newVPN && !validateIPv4(newVPN)) {
        alert('VPN IP address must be a valid IPv4 format.');
        return;
    }

    fetch('/api/hosts/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            old_ip: oldIP,
            ip_address: newIP,
            vpn_ip_address: newVPN,
            nickname: nickname,
            notes: notes
        })
    }).then(resp => {
        if (!resp.ok) {
            throw new Error('update failed');
        }

        row.dataset.ip = newIP;
        row.dataset.vpn = newVPN;

        const hostname = row.dataset.hostname || '';

        if (nicknameDisplay) {
            if (nickname) {
                nicknameDisplay.innerHTML = `${nickname}${hostname ? ` <span class="text-desert-gray text-xs">(${hostname})</span>` : ''}`;
            } else if (hostname) {
                nicknameDisplay.innerHTML = `<span class="text-desert-gray italic">unnamed</span> <span class="text-desert-gray text-xs">(${hostname})</span>`;
            } else {
                nicknameDisplay.innerHTML = '<span class="text-desert-gray italic">unnamed</span>';
            }
            nicknameDisplay.classList.remove('hidden');
        }

        if (nicknameInput) {
            nicknameInput.classList.add('hidden');
        }

        if (lanDisplay) {
            lanDisplay.innerHTML = `${newIP}<span class="checking-indicator invisible text-orange-400 italic text-xs ml-2">(checking)</span>`;
            lanDisplay.classList.remove('hidden');
        }
        if (lanInput) {
            lanInput.classList.add('hidden');
        }

        if (vpnDisplay) {
            if (newVPN) {
                vpnDisplay.textContent = newVPN;
                vpnDisplay.classList.remove('text-desert-gray', 'italic');
                vpnDisplay.classList.add('text-desert-tan');
            } else {
                vpnDisplay.textContent = '‚Äî';
                vpnDisplay.classList.remove('text-desert-tan');
                vpnDisplay.classList.add('text-desert-gray', 'italic');
            }
            vpnDisplay.classList.remove('hidden');
        }
        if (vpnInput) {
            vpnInput.classList.add('hidden');
        }

        if (notesDisplay) {
            if (notes) {
                notesDisplay.textContent = notes;
                notesDisplay.classList.remove('text-desert-gray', 'italic');
                notesDisplay.classList.add('text-desert-tan');
            } else {
                notesDisplay.textContent = '‚Äî';
                notesDisplay.classList.remove('text-desert-tan');
                notesDisplay.classList.add('text-desert-gray', 'italic');
            }
            notesDisplay.classList.remove('hidden');
        }
        if (notesInput) {
            notesInput.classList.add('hidden');
        }

        row.querySelector('.edit-btn').classList.remove('hidden');
        row.querySelector('.save-btn').classList.add('hidden');
        row.querySelector('.cancel-btn').classList.add('hidden');

        window.resetCountdown();

        setTimeout(() => {
            window.triggerHostsRefresh();
        }, 500);
    }).catch(() => {
        alert('Failed to update host. Please try again.');
    });
};

window.addHost = function(event) {
    event.preventDefault();

    const nicknameInput = document.getElementById('new-nickname');
    const lanInput = document.getElementById('new-lan-ip');
    const vpnInput = document.getElementById('new-vpn-ip');
    const notesInput = document.getElementById('new-notes');

    const nickname = nicknameInput.value.trim();
    const lanIP = lanInput.value.trim();
    const vpnIP = vpnInput.value.trim();
    const notes = notesInput.value.trim();

    if (!validateIPv4(lanIP)) {
        alert('Please enter a valid LAN IPv4 address.');
        return;
    }

    if (vpnIP && !validateIPv4(vpnIP)) {
        alert('VPN IP address must be a valid IPv4 format.');
        return;
    }

    fetch('/api/hosts/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            nickname: nickname,
            ip_address: lanIP,
            vpn_ip_address: vpnIP,
            notes: notes
        })
    }).then(resp => {
        if (!resp.ok) {
            throw new Error('add failed');
        }

        nicknameInput.value = '';
        lanInput.value = '';
        vpnInput.value = '';
        notesInput.value = '';

        lanInput.blur();

        window.triggerHostsRefresh();
    }).catch(() => {
        alert('Failed to add host. Please try again.');
    });
};

window.toggleInfo = function(button, ip) {
    const row = button.closest('tr');
    const existingInfoRow = document.querySelector('.info-row');

    if (existingInfoRow) {
        existingInfoRow.remove();
        if (existingInfoRow.dataset.ip === ip) {
            return;
        }
    }

    const infoRow = document.createElement('tr');
    infoRow.className = 'info-row bg-black';
    infoRow.dataset.ip = ip;

    const infoCell = document.createElement('td');
    infoCell.colSpan = HOST_TABLE_COLUMN_COUNT;
    infoCell.className = 'px-4 py-4';
    infoCell.innerHTML = '<div class="text-desert-tan text-sm"><span class="text-cyan-400 italic">Loading device information...</span></div>';

    infoRow.appendChild(infoCell);
    row.after(infoRow);

    Promise.all([
        fetch(`/api/proxy/anthias?ip=${ip}&path=/api/v2/device_settings`).then(r => r.ok ? r.json() : null),
        fetch(`/api/proxy/anthias?ip=${ip}&path=/api/v1/info`).then(r => r.ok ? r.json() : null),
        fetch(`/api/proxy/anthias?ip=${ip}&path=/api/v1/assets?format=json`).then(r => r.ok ? r.json() : null)
    ]).then(([settings, info, assets]) => {
        let html = '<div class="text-desert-tan text-sm space-y-3">';

        if (settings) {
            html += '<div class="font-semibold text-desert-cyan mb-2">Device Settings:</div>';
            html += '<div class="grid grid-cols-3 gap-x-4 gap-y-2 ml-4">';
            for (const [key, value] of Object.entries(settings)) {
                if (value !== null && value !== undefined && value !== '') {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    let displayValue = value;
                    if (typeof value === 'boolean') {
                        displayValue = value ? 'Yes' : 'No';
                    }
                    html += `<div><span class="text-gray-400">${label}:</span> ${displayValue}</div>`;
                }
            }
            html += '</div>';
        }

        if (info) {
            html += '<div class="font-semibold text-desert-cyan mt-3 mb-2">System Info:</div>';
            html += '<div class="grid grid-cols-3 gap-x-4 gap-y-2 ml-4">';
            for (const [key, value] of Object.entries(info)) {
                if (value !== null && value !== undefined && value !== '') {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `<div><span class="text-gray-400">${label}:</span> ${value}</div>`;
                }
            }
            html += '</div>';
        }

        if (assets && Array.isArray(assets)) {
            html += '<div class="font-semibold text-desert-cyan mt-3 mb-2">Assets: ' + assets.length + '</div>';
            if (assets.length > 0) {
                const mediaAssets = assets.filter(a =>
                    a.mimetype && (a.mimetype.startsWith('image/') || a.mimetype.startsWith('video/'))
                ).slice(0, 5);

                if (mediaAssets.length > 0) {
                    html += '<div class="ml-4 mb-3 flex gap-2 flex-wrap">';
                    mediaAssets.forEach(asset => {
                        if (asset.uri) {
                            const thumbnailUrl = `http://${ip}${asset.uri}`;
                            if (asset.mimetype.startsWith('image/')) {
                                html += `<img src="${thumbnailUrl}" class="h-20 w-auto object-cover rounded border border-gray-600" title="${asset.name || 'Unnamed'}" onerror="this.style.display='none'">`;
                            } else if (asset.mimetype.startsWith('video/')) {
                                html += `<video class="h-20 w-auto object-cover rounded border border-gray-600" title="${asset.name || 'Unnamed'}" muted><source src="${thumbnailUrl}" type="${asset.mimetype}"></video>`;
                            }
                        }
                    });
                    html += '</div>';
                }

                html += '<div class="ml-4 space-y-1 max-h-40 overflow-y-auto">';
                assets.forEach(asset => {
                    html += `<div class="text-xs flex items-center gap-2">`;
                    if (asset.is_enabled) html += `<span class="text-green-400">‚óè</span>`;
                    else html += `<span class="text-gray-600">‚óã</span>`;
                    html += `<span class="text-gray-300">${asset.name || 'Unnamed'}</span>`;
                    if (asset.mimetype) html += ` <span class="text-gray-500">(${asset.mimetype})</span>`;
                    if (asset.duration) html += ` <span class="text-gray-500">${asset.duration}s</span>`;
                    html += `</div>`;
                });
                html += '</div>';
            }
        }

        html += '</div>';

        if (!settings && !info && !assets) {
            html = '<div class="text-red-400 text-sm">Failed to retrieve device information. Anthias API may be unavailable.</div>';
        }

        infoCell.innerHTML = html;
    }).catch(() => {
        infoCell.innerHTML = '<div class="text-red-400 text-sm">Error fetching device information.</div>';
    });
};

if (!window.countdownStarted) {
    window.countdownStarted = true;
    document.addEventListener('DOMContentLoaded', function() {
        window.startCountdown();
    });
    window.startCountdown();
}

if (typeof window.infoRowState === 'undefined') {
    window.infoRowState = null;
}

document.body.addEventListener('htmx:beforeSwap', function() {
    const infoRow = document.querySelector('.info-row');
    if (infoRow) {
        window.infoRowState = {
            ip: infoRow.dataset.ip,
            html: infoRow.querySelector('td').innerHTML
        };
    } else {
        window.infoRowState = null;
    }
});

document.body.addEventListener('htmx:afterSwap', function() {
    if (window.infoRowState && window.infoRowState.ip) {
        const hostRow = document.querySelector(`tr[data-ip="${window.infoRowState.ip}"]`);
        if (hostRow) {
            const infoRow = document.createElement('tr');
            infoRow.className = 'info-row bg-black';
            infoRow.dataset.ip = window.infoRowState.ip;

            const infoCell = document.createElement('td');
            infoCell.colSpan = HOST_TABLE_COLUMN_COUNT;
            infoCell.className = 'px-4 py-4';
            infoCell.innerHTML = window.infoRowState.html;

            infoRow.appendChild(infoCell);
            hostRow.after(infoRow);
        }
    }
});
</script>
